<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jednoduchý Budík</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #27284b;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-width: 450px;
            width: 100%;
            text-align: center;
            border: 2px solid #5a5f78;
        }
        .time-display {
            font-size: 4rem;
            font-weight: 600;
            margin-bottom: 2rem;
            color: #b8c1ec;
            text-shadow: 0 0 10px rgba(184, 193, 236, 0.6);
        }
        .alarm-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
        }
        input[type="time"], input[type="text"] {
            background-color: #1a1a2e;
            border: 2px solid #5a5f78;
            color: #b8c1ec;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 1.25rem;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 100%;
        }
        input[type="time"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #8c9eff;
            box-shadow: 0 0 10px rgba(140, 158, 255, 0.5);
        }
        .button {
            background-color: #b8c1ec;
            color: #1a1a2e;
            padding: 0.75rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        .button:hover {
            background-color: #8c9eff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(140, 158, 255, 0.4);
        }
        .button-group {
            display: flex;
            gap: 1rem;
            width: 100%;
            justify-content: center;
        }
        .message-box {
            background-color: #3b436b;
            color: #e0e0e0;
            padding: 1rem;
            border-radius: 12px;
            margin-top: 2rem;
            display: none;
            border: 1px solid #5a5f78;
            word-wrap: break-word;
        }
        .loading-spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8c9eff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1rem auto 0;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold mb-4 text-purple-200">Jednoduchý Budík</h1>
        <div id="currentTime" class="time-display"></div>
        
        <form id="alarmForm" class="alarm-form">
            <label for="alarmTime" class="text-lg text-purple-200">Nastav čas budíka:</label>
            <input type="time" id="alarmTime" required>
            
            <label for="nameInput" class="text-lg text-purple-200">Zadaj svoje meno:</label>
            <input type="text" id="nameInput" placeholder="Napr. Kikuško alebo Kristián" required>
            
            <div class="button-group">
                <button type="submit" id="cheerfulAlarmBtn" class="button flex-1">Nastaviť veselý budík</button>
                <button type="submit" id="angryAlarmBtn" class="button flex-1">Nastaviť nahnevaný budík</button>
            </div>
        </form>

        <div id="loadingSpinner" class="loading-spinner"></div>
        <div id="messageBox" class="message-box"></div>
    </div>

    <script>
        const currentTimeDisplay = document.getElementById('currentTime');
        const alarmTimeInput = document.getElementById('alarmTime');
        const nameInput = document.getElementById('nameInput');
        const cheerfulAlarmBtn = document.getElementById('cheerfulAlarmBtn');
        const angryAlarmBtn = document.getElementById('angryAlarmBtn');
        const messageBox = document.getElementById('messageBox');
        const loadingSpinner = document.getElementById('loadingSpinner');

        let alarmTimeout;
        let alarmAudio;
        
        // Funkcia na zobrazenie aktuálneho času
        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            currentTimeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
        }

        // Aktualizovať čas každú sekundu
        setInterval(updateTime, 1000);
        updateTime();

        // Pomocné funkcie pre konverziu PCM dát
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            
            let pos = 0;
            function writeString(s) {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(pos++, s.charCodeAt(i));
                }
            }
            function writeUint32(i) {
                view.setUint32(pos, i, true);
                pos += 4;
            }
            function writeUint16(i) {
                view.setUint16(pos, i, true);
                pos += 2;
            }

            writeString('RIFF');
            writeUint32(36 + pcm16.length * 2);
            writeString('WAVE');
            writeString('fmt ');
            writeUint32(16);
            writeUint16(1);
            writeUint16(1);
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2);
            writeUint16(2);
            writeUint16(16);
            writeString('data');
            writeUint32(pcm16.length * 2);
            
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(pos, pcm16[i], true);
                pos += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        // Funkcia na zobrazenie správ
        function showMessage(message, isError) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            if (isError) {
                messageBox.style.color = '#ff6b6b';
            } else {
                messageBox.style.color = '#e0e0e0';
            }
        }

        // Funkcia na spustenie zvuku budíka
        function playAlarm(audioData) {
            if (alarmAudio) {
                alarmAudio.pause();
                alarmAudio.currentTime = 0;
            }
            const audioUrl = URL.createObjectURL(audioData);
            alarmAudio = new Audio(audioUrl);
            alarmAudio.play();
            // Zastav budík po 30 sekundách
            setTimeout(() => {
                alarmAudio.pause();
                alarmAudio.currentTime = 0;
                URL.revokeObjectURL(audioUrl); // Uvoľniť pamäť
            }, 30000);
        }

        // Funkcia na volanie TTS API a nastavenie budíka
        async function setAlarm(promptText) {
            const alarmTime = alarmTimeInput.value;
            const name = nameInput.value;

            if (!alarmTime || !name) {
                showMessage('Prosím, zadajte čas a meno.', true);
                return;
            }

            loadingSpinner.style.display = 'block';
            showMessage('Pripravujem hlasovú správu...', false);

            try {
                const payload = {
                    contents: [{
                        parts: [{ text: promptText }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API chyba: ${response.statusText}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);

                    loadingSpinner.style.display = 'none';
                    
                    const now = new Date();
                    const [alarmHours, alarmMinutes] = alarmTime.split(':').map(Number);
                    const alarmDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), alarmHours, alarmMinutes, 0, 0);

                    // Ak je nastavený čas v minulosti, nastav budík na nasledujúci deň
                    if (alarmDate <= now) {
                        alarmDate.setDate(alarmDate.getDate() + 1);
                    }

                    const timeToAlarm = alarmDate.getTime() - now.getTime();

                    // Zrušenie predchádzajúceho budíka, ak nejaký existuje
                    if (alarmTimeout) {
                        clearTimeout(alarmTimeout);
                    }
                    
                    showMessage(`Budík pre meno "${name}" je nastavený na ${String(alarmHours).padStart(2, '0')}:${String(alarmMinutes).padStart(2, '0')}.`, false);

                    alarmTimeout = setTimeout(() => {
                        showMessage('Budík zvoní! Je čas vstať.', false);
                        playAlarm(wavBlob);
                    }, timeToAlarm);
                } else {
                    throw new Error('Nepodarilo sa získať zvukové dáta z API.');
                }

            } catch (error) {
                loadingSpinner.style.display = 'none';
                console.error("Chyba pri generovaní zvuku:", error);
                showMessage(`Nastala chyba: ${error.message}. Skúste to prosím znova.`, true);
            }
        }

        // Event listener pre veselý budík
        cheerfulAlarmBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const name = nameInput.value;
            if (name) {
                const prompt = `Povedz veselým hlasom: ${name}, vstávaj! ${name}, vstávaj!`;
                setAlarm(prompt);
            } else {
                showMessage('Prosím, zadajte svoje meno.', true);
            }
        });

        // Event listener pre nahnevaný budík
        angryAlarmBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const name = nameInput.value;
            if (name) {
                const prompt = `Povedz nahnevaným hlasom: ${name}, VSTÁVAJ!`;
                setAlarm(prompt);
            } else {
                showMessage('Prosím, zadajte svoje meno.', true);
            }
        });
    </script>
</body>
</html>
